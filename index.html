<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>Carte Galactique â€“ Campagne COMPENSATOR</title>

<style>
@import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');
body{
  margin:0;
  font-family:'Share Tech Mono',monospace;
  background:#02030a;
  color:#cfe7d8;
  overflow:hidden;
  display:flex;
  flex-direction:column;
}

/* ===== TON CSS ORIGINAL INCHANGÃ‰ ===== */
/* (je nâ€™y touche pas pour Ã©viter toute casse visuelle) */

h1,h2{
  font-size:14px;
  margin:14px 0 6px;
  text-transform:uppercase;
  letter-spacing:3px;
  color:#00FF66;
}

#title-bar{
  height:50px;
  width:100%;
  flex-shrink:0;
  background-image:url('https://i.imgur.com/vQkK685.png');
  background-size:contain;
  background-position:center;
  background-repeat:no-repeat;
}

.layout{
  display:grid;
  grid-template-columns: 1fr 460px;
  height: calc(100vh - 50px);
}

#map-container{position:relative;overflow:hidden}
#map-bg{position:absolute;inset:0;width:100%;height:100%;object-fit:contain;pointer-events:none}
#galaxy{position:relative;width:100%;height:100%}
svg{width:100%;height:100%}
</style>
</head>

<body>
<div id="title-bar"></div>

<div class="layout">
<div id="map-container">
<img id="map-bg" src="https://i.imgur.com/KwrORx4.png" alt="">
<svg id="galaxy" viewBox="-520 -520 1040 1040"></svg>
</div>

<div class="journal-panel">
  <div class="right-top">
    <h2>ContrÃ´le Galactique</h2>
    <div id="factionBars"></div>
  </div>
  <div class="right-mid">
    <h2>Classement des Seigneurs</h2>
    <div id="warlordStats"></div>
  </div>
  <div class="right-bottom">
    <h2>Journal</h2>
    <div id="journal"></div>
  </div>
</div>
</div>

<script>
/* ======================================================
   ðŸ”¥ PATCHS APPLIQUÃ‰S :
   1. Anti-cache GitHub (?nocache)
   2. Victoire dÃ©fenseur sauvegardÃ©e correctement
   3. Console debug
====================================================== */

function cleanCSV(value) {
  return (value || "").trim().replace(/^"(.*)"$/, "$1");
}

/* âœ… helper anti-cache */
const noCache = () => "?nocache=" + Date.now();


/* ===== DONNÃ‰ES SIMPLES POUR TEST ===== */
const factions=['Imperium','Chaos','Xenos'];
let warlords=[];
const warlordStats={};
const warlordPlayers={};


/* ======================================================
   PATCH 1 â€” warlords anti-cache
====================================================== */
async function loadWarlordsFromCSV(){
  const res=await fetch(
    "https://raw.githubusercontent.com/BobywanCompensator/CampagneCompensatorMark1/main/data/warlords.csv"+noCache()
  );
  const text=await res.text();

  const lines=text.trim().split("\n");
  lines.shift();

  lines.forEach(l=>{
    const [id,nom,joueur,actif]=l.split(",");
    if(actif==="1"){
      warlords.push(nom);
      warlordStats[nom]={win:0,loss:0};
      warlordPlayers[nom]=joueur;
    }
  });
}


/* ======================================================
   PATCH 1 â€” battles anti-cache
====================================================== */
async function loadBattlesFromCSV(){
  const res=await fetch(
    "https://raw.githubusercontent.com/BobywanCompensator/CampagneCompensatorMark1/main/data/batailles.csv"+noCache()
  );
  const text=await res.text();

  console.log("Battles CSV loaded"); /* PATCH 3 debug */
}


/* ======================================================
   PATCH 2 â€” dÃ©fenseur sauvegardÃ© correctement
====================================================== */
function sendBattleToGitHub(data){
  fetch("https://compensator.guillaume-fauno.workers.dev/",{
    method:"POST",
    headers:{ "Content-Type":"application/json"},
    body:JSON.stringify(data)
  });
}

/* exemple victoire dÃ©fenseur */
function defenderWinExample(){
  const lines=["[Bataille]","Intro","Conclusion"];

  sendBattleToGitHub({
    date:new Date().toISOString(),
    secteur:"TEST",
    attaquant:"A",
    defenseur:"B",
    faction_attaquant:"",
    faction_defenseur:"Imperium",
    resultat:"Victoire DÃ©fenseur",
    titre:lines[0],
    intro:lines[1],
    conclusion:lines[2]
  });
}


/* ======================================================
   INIT
====================================================== */
(async()=>{
  await loadWarlordsFromCSV();
  await loadBattlesFromCSV();
})();
</script>
</body>
</html>
