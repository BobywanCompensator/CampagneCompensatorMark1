<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>Carte Galactique â€“ Campagne COMPENSATOR</title>

<style>
/* --- (CSS inchangÃ©, je ne le retouche pas) --- */
</style>
</head>

<body>
<div id="title-bar"></div>

<div class="layout">
<div id="map-container">
<img id="map-bg" src="https://i.imgur.com/KwrORx4.png" alt="">
<svg id="galaxy" viewBox="-520 -520 1040 1040"></svg>
</div>

<div class="journal-panel">
  <div class="right-top">
    <h2>ContrÃ´le Galactique</h2>
    <div id="factionBars"></div>
  </div>
  <div class="right-mid">
    <h2>Classement des Seigneurs</h2>
    <div id="warlordStats"></div>
  </div>
  <div class="right-bottom">
    <h2>Journal</h2>
    <div id="journal"></div>
  </div>
</div>
</div>

<script>

/* =========================================================
   ðŸ”¥ PATCHES INCLUS
   1. Bypass cache GitHub
   2. Victoire dÃ©fenseur sauvegardÃ©e correctement
   3. Debug console
========================================================= */

function cleanCSV(value) {
  return (value || "").trim().replace(/^"(.*)"$/, "$1");
}

/* ===== UTIL ===== */
const noCache = () => "?nocache=" + Date.now();


/* =========================================================
   WARLORDS  (PATCH anti-cache)
========================================================= */
async function loadWarlordsFromCSV() {
  const res = await fetch(
    "https://raw.githubusercontent.com/BobywanCompensator/CampagneCompensatorMark1/main/data/warlords.csv" + noCache()
  );

  const text = await res.text();

  const lines = text.trim().split("\n");
  lines.shift();

  warlords = [];

  lines.forEach(line => {
    if (!line.trim()) return;

    const [id, nom, joueur, actif] = line.split(",");

    if (actif === "1" && nom) {
      warlords.push(nom);
      warlordStats[nom] = { win: 0, loss: 0 };
      warlordPlayers[nom] = joueur || "";
    }
  });
}


/* =========================================================
   SECTORS INIT (PATCH anti-cache)
========================================================= */
async function loadInitialSectors() {
  const res = await fetch(
    "https://raw.githubusercontent.com/BobywanCompensator/CampagneCompensatorMark1/main/data/sectors.csv" + noCache()
  );

  const text = await res.text();

  const lines = text.trim().split("\n");
  lines.shift();

  const initialOwners = {};

  lines.forEach(line => {
    const [nom, owner] = line.split(",");
    initialOwners[nom] = owner;
  });

  sectors.forEach(s => {
    if (initialOwners[s.name]) s.owner = initialOwners[s.name];
  });
}


/* =========================================================
   BATTLES (PATCH anti-cache + debug)
========================================================= */
async function loadBattlesFromCSV() {
  const res = await fetch(
    "https://raw.githubusercontent.com/BobywanCompensator/CampagneCompensatorMark1/main/data/batailles.csv" + noCache()
  );

  const text = await res.text();

  const rows = parseCSV(text.trim());
  const headers = rows.shift();

  const battles = rows.map(row => {
    const obj = {};
    headers.forEach((h, i) => obj[h] = row[i]);
    return obj;
  });

  console.log("Battles loaded:", battles.length); // âœ… DEBUG

  applyBattles(battles);
  buildJournalFromBattles(battles);
}


/* =========================================================
   PATCH MAJEUR : victoire dÃ©fenseur
========================================================= */

function openBattleConsole(sector){
  if(battleOpen || sector.immutable) return;
  battleOpen=true;

  const j=document.getElementById('journal');
  const e=document.createElement('div');
  e.className='journal-entry';

  const attackers=factions.filter(f=>f!==sector.owner);

  e.innerHTML=`
  > ENGAGEMENT â€“ ${sector.name}<br>
  DÃ©fenseur (${sector.owner})<br>
  <select class="def">${warlords.map(w=>`<option>${w}</option>`).join('')}</select><br>
  Attaquant<br>
  <select class="atkF">${attackers.map(f=>`<option>${f}</option>`).join('')}</select>
  <select class="atk">${warlords.map(w=>`<option>${w}</option>`).join('')}</select><br>
  <button class="awin">Victoire Attaquant</button>
  <button class="dwin">Victoire DÃ©fenseur</button>
  <button class="cancel">Annuler</button>
  `;

  /* ---------- ATTAQUANT (inchangÃ©) ---------- */
  e.querySelector('.awin').onclick=()=>{
    const atk=e.querySelector('.atk').value;
    const def=e.querySelector('.def').value;

    const atkFaction=e.querySelector('.atkF').value;
    const oldOwner=sector.owner;

    sector.owner=atkFaction;
    sector.battles++;
    warlordStats[atk].win++;
    warlordStats[def].loss++;

    const lines=narrate(sector,atk,def,atkFaction,oldOwner,true);

    j.prepend(makeEntry(lines));

    sendBattleToGitHub({
      date:new Date().toISOString(),
      secteur:sector.name,
      attaquant:atk,
      defenseur:def,
      faction_attaquant:atkFaction,
      faction_defenseur:oldOwner,
      resultat:"Victoire Attaquant",
      titre:lines[0],
      intro:lines[1],
      conclusion:lines[2]
    });

    close();
  };

  /* ---------- âœ… DEFENSEUR PATCH COMPLET ---------- */
  e.querySelector('.dwin').onclick=()=>{
    const atk=e.querySelector('.atk').value;
    const def=e.querySelector('.def').value;

    const oldOwner=sector.owner;

    sector.battles++;
    warlordStats[atk].loss++;
    warlordStats[def].win++;

    const lines=narrate(sector,atk,def,'',oldOwner,false);

    j.prepend(makeEntry(lines));

    sendBattleToGitHub({
      date:new Date().toISOString(),
      secteur:sector.name,
      attaquant:atk,
      defenseur:def,
      faction_attaquant:"",
      faction_defenseur:oldOwner,
      resultat:"Victoire DÃ©fenseur",
      titre:lines[0],
      intro:lines[1],
      conclusion:lines[2]
    });

    close();
  };

  function makeEntry(lines){
    const d=document.createElement('div');
    d.className='journal-entry';
    d.innerHTML=`<div>${lines[0]}</div><div>${lines[1]}</div><div>${lines[2]}</div>`;
    return d;
  }

  function close(){
    e.remove();
    battleOpen=false;
    render();
    renderWarlords();
  }

  e.querySelector('.cancel').onclick=close;
  j.prepend(e);
}

</script>
</body>
</html>
