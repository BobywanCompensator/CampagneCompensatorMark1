<script>
/* ===== GITHUB CONFIG ===== */
function cleanCSV(value) {
  return (value || "")
    .trim()
    .replace(/^"(.*)"$/, "$1");
}

/* =========================================================
   âœ… PATCH 1 â€” helper anti-cache GitHub
========================================================= */
const noCache = () => "?nocache=" + Date.now();


const GITHUB_USER = "BobywanCompensator";
const GITHUB_REPO = "CampagneCompensatorMark1";
const SCALE = 0.85;


/* ===== WARLORDS ===== */
let warlords = [];
const warlordStats = {};
const warlordPlayers = {};


/* =========================================================
   âœ… PATCH 1 APPLIQUÃ‰ ICI (anti-cache)
========================================================= */
async function loadWarlordsFromCSV() {
  const res = await fetch(
    "https://raw.githubusercontent.com/BobywanCompensator/CampagneCompensatorMark1/main/data/warlords.csv" + noCache()
  );

  const text = await res.text();

  const lines = text.trim().split("\n");
  lines.shift();

  warlords = [];

  lines.forEach(line => {
    if (!line.trim()) return;

    const values = line.split(",");
    if (values.length < 4) return;

    const [id, nom, joueur, actif] = values.map(v => v.trim());

    if (actif === "1" && nom) {
      warlords.push(nom);
      warlordStats[nom] = { win: 0, loss: 0 };
      warlordPlayers[nom] = joueur || "";
    }
  });
}


/* =========================================================
   âœ… PATCH 1 APPLIQUÃ‰ ICI (anti-cache)
========================================================= */
async function loadInitialSectors() {
  const res = await fetch(
    "https://raw.githubusercontent.com/BobywanCompensator/CampagneCompensatorMark1/main/data/sectors.csv" + noCache()
  );

  const text = await res.text();

  const lines = text.trim().split("\n");
  lines.shift();

  const initialOwners = {};

  lines.forEach(line => {
    if (!line.trim()) return;

    const parts = line.split(",");
    if (parts.length < 2) return;

    const nom = parts[0].trim();
    const owner = parts[1].trim();

    if (nom && owner) {
      initialOwners[nom] = owner;
    }
  });

  sectors.forEach(s => {
    if (initialOwners[s.name]) {
      s.owner = initialOwners[s.name];
    }
  });
}


/* =========================================================
   âœ… PATCH 1 APPLIQUÃ‰ ICI (anti-cache)
   âœ… PATCH 3 DEBUG ajoutÃ©
========================================================= */
async function loadBattlesFromCSV() {
  const res = await fetch(
    "https://raw.githubusercontent.com/BobywanCompensator/CampagneCompensatorMark1/main/data/batailles.csv" + noCache()
  );

  const text = await res.text();

  const rows = parseCSV(text.trim());
  const headers = rows.shift();

  const battles = rows.map(row => {
    const obj = {};
    headers.forEach((h, i) => obj[h] = row[i]);
    return obj;
  });

  console.log("Battles loaded:", battles.length); // âœ… DEBUG

  applyBattles(battles);
  buildJournalFromBattles(battles);
}


/* =========================================================
   âœ… PATCH 2 â€” victoire dÃ©fenseur FIX
========================================================= */

function openBattleConsole(sector){
  if(battleOpen) return;
  if(sector.immutable) return;
  battleOpen=true;

  const j=document.getElementById('journal');
  const e=document.createElement('div');
  e.className='journal-entry';

  const attackers=factions.filter(f=>f!==sector.owner);

  e.innerHTML=`
  > ENGAGEMENT â€“ ${sector.name}<br>
  DÃ©fenseur (${sector.owner})<br>
  <select class="def">${warlords.map(w=>`<option>${w}</option>`).join('')}</select><br>
  Attaquant<br>
  <select class="atkF">${attackers.map(f=>`<option>${f}</option>`).join('')}</select>
  <select class="atk">${warlords.map(w=>`<option>${w}</option>`).join('')}</select><br>
  <button class="awin">Victoire Attaquant</button>
  <button class="dwin">Victoire DÃ©fenseur</button>
  <button class="cancel">Annuler</button>
  `;


  /* ===== DEFENSEUR PATCHÃ‰ ===== */
  e.querySelector('.dwin').onclick=()=>{
    const atk=e.querySelector('.atk').value;
    const def=e.querySelector('.def').value;
    if(!validWarlords(atk,def)) return;

    const oldOwner=sector.owner;

    sector.battles++;
    warlordStats[atk].loss++;
    warlordStats[def].win++;

    const lines=narrate(sector,atk,def,'',oldOwner,false);

    const entry=document.createElement('div');
    entry.className='journal-entry';
    entry.innerHTML=`<div>${lines[0]}</div><div>${lines[1]}</div><div>${lines[2]}</div>`;
    j.prepend(entry);

    /* ðŸ”¥ FORMAT IDENTIQUE A ATTAQUANT (FIX) */
    sendBattleToGitHub({
      date: new Date().toISOString(),
      secteur: sector.name,
      attaquant: atk,
      defenseur: def,
      faction_attaquant: "",
      faction_defenseur: oldOwner,
      resultat: "Victoire DÃ©fenseur",
      titre: lines[0],
      intro: lines[1],
      conclusion: lines[2]
    });

    e.remove();
    battleOpen=false;
    render();
    renderWarlords();
  };
}

</script>
